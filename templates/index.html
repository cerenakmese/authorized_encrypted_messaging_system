<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grup 34 - GÃ¼venli MesajlaÅŸma</title>
    <!-- TasarÄ±m iÃ§in Bootstrap (CDN) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .encrypted-text {
            color: #dc3545;
            font-family: monospace;
            word-break: break-all;
        }

        .decrypted-text {
            color: #198754;
            font-weight: bold;
        }

        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>

    <div class="container py-5">
        <h2 class="text-center mb-4">ğŸ” Grup 34 - Secure Messaging System</h2>

        <!-- Kimlik SeÃ§imi (SimÃ¼lasyon) -->
        <div class="card p-3 mb-4 bg-dark text-white">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <label>KullanÄ±cÄ± AdÄ±nÄ±z:</label>
                    <input type="text" id="currentUser" class="form-control" value="ZiyaretÃ§i">
                </div>
                <div class="col-md-3">
                    <label>Sistemdeki RolÃ¼nÃ¼z:</label>
                    <select id="currentRole" class="form-select">
                        <option value="User">User (Yetkisiz)</option>
                        <option value="Admin">Admin (Tam Yetkili)</option>
                        <option value="Manager">Manager (Tam Yetkili)</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <small class="text-warning">
                        * Not: 'User' rolÃ¼ seÃ§iliyken mesajlarÄ±n iÃ§eriÄŸini ÅŸifreli gÃ¶rÃ¼rsÃ¼nÃ¼z.<br>
                        * 'Admin' seÃ§erseniz sistem ÅŸifreleri Ã§Ã¶zer.
                    </small>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- SOL TARA: Mesaj GÃ¶nderme -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">Yeni Mesaj GÃ¶nder</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label>MesajÄ±nÄ±z:</label>
                            <textarea id="msgInput" class="form-control" rows="3"></textarea>
                        </div>
                        <button onclick="sendMessage()" class="btn btn-primary w-100">ğŸ”’ Åifrele ve GÃ¶nder</button>
                        <div id="statusMsg" class="mt-2 text-center text-muted"></div>
                    </div>
                </div>
            </div>

            <!-- SAÄ TARAF: Gelen Kutusu -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        Gelen Kutusu (MongoDB Logs)
                        <button onclick="loadMessages()" class="btn btn-sm btn-light">ğŸ”„ Yenile</button>
                    </div>
                    <div class="card-body">
                        <div id="messageList" class="list-group">
                            <!-- Mesajlar buraya gelecek -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mesaj GÃ¶nderme Fonksiyonu
        async function sendMessage() {
            const username = document.getElementById('currentUser').value;
            const role = document.getElementById('currentRole').value;
            const message = document.getElementById('msgInput').value;

            if (!message) return alert("LÃ¼tfen bir mesaj yazÄ±n!");

            const response = await fetch('/send_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, role, message })
            });

            const result = await response.json();
            if (result.success) {
                document.getElementById('statusMsg').innerText = "âœ… " + result.info;
                document.getElementById('msgInput').value = "";
                loadMessages(); // Listeyi yenile
            } else {
                alert("Hata: " + result.error);
            }
        }

        // MesajlarÄ± Listeleme Fonksiyonu
        async function loadMessages() {
            // Åu an seÃ§ili olan rolÃ¼ backend'e gÃ¶nderiyoruz
            const currentRole = document.getElementById('currentRole').value;

            const response = await fetch(`/get_messages?current_role=${currentRole}`);
            const messages = await response.json();

            const listDiv = document.getElementById('messageList');
            listDiv.innerHTML = ""; // Temizle

            messages.forEach(msg => {
                const isEncrypted = msg.status === "encrypted";
                const textClass = isEncrypted ? "encrypted-text" : "decrypted-text";
                const icon = isEncrypted ? "ğŸ”’" : "ğŸ”“";

                const html = `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1 text-primary">${msg.sender} <span class="badge bg-secondary">${msg.role}</span></h6>
                        <small class="text-muted">${msg.timestamp}</small>
                    </div>
                    <p class="mb-1 ${textClass}">${icon} ${msg.text}</p>
                    <small class="text-muted">Algoritma: <strong>${msg.algo}</strong></small>
                </div>
            `;
                listDiv.innerHTML += html;
            });
        }

        // Sayfa aÃ§Ä±lÄ±nca mesajlarÄ± yÃ¼kle
        loadMessages();

        // Rol deÄŸiÅŸince listeyi otomatik yenile (FarkÄ± gÃ¶rmek iÃ§in)
        document.getElementById('currentRole').addEventListener('change', loadMessages);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>